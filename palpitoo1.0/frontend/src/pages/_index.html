<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Palpitoo - P√°gina Inicial</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Salsa&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>

  <header class="navbar">
    <a href="http://localhost:5501/palpitoo1.0/frontend/src/pages/inicio.html" style="text-decoration: none; color: inherit;">
        <div class="logo-container">
            <div class="logo-icon">P</div>
            <h1 class="logo-text font-russo">Palpi<span style="color: var(--accent-cyan);">too</span></h1>
        </div>
    </a>
    
    <nav>
      <ul class="nav-links">
        <li><a href="_index.html" class="ativo">in√≠cio</a></li> 
        <li><a href="ligas.html">Ligas</a></li> 
        <li><a href="palpites.html">Palpites</a></li>
        <li><a href="novidades.html">Novidades</a></li>
        <li><a href="social.html">Social</a></li>
        <li><a href="carreira.html">Carreira</a></li>
        
      </ul>
    </nav>
  </header>

  <main class="container-principal dashboard-layout">
    
    <aside class="cartao bg-claro cartao-perfil animacao-suave">
              
    <div class="perfil-topo" style="display: flex; flex-direction: column; align-items: center;">
      
      <img src="https://via.placeholder.com/60" alt="Foto do usu√°rio" id="fotoPerfil" class="foto-perfil" style="border-radius: 50%; width: 80px; height: 80px; object-fit: cover;">
<!--  
      <label for="inputFoto" class="cursor-pointer text-sm text-blue-600 font-bold mb-5 hover:underline">
        Trocar Foto
      </label>
      <input type="file" id="inputFoto" accept="image/*" class="hidden" onchange="salvarFoto()">
-->   
      <h2 class="font-russo titulo-azul" id="textoNome">Carregando...</h2>
      <p class="font-russo text-gray-600 mt-5" style="font-size: 0.9em;">
        Time: <span id="textoTime" class="text-blue-800">Nenhum</span>
      </p>
    </div>
  
      <hr class="linha-divisoria mt-15 mb-15">
      
<h3 class="font-russo titulo-azul">Desempenho na temporada</h3>
      <ul class="lista-desempenho mt-10">
        <li>
          <span class="icone">üéØ</span> 
          <strong id="stat-cravadas">0</strong> 
          <span style="font-size: 0.7em; color: gray; margin-left: 5px;">Crava√ß√µes (3pts)</span>
        </li>
        <li>
          <span class="icone">‚úîÔ∏è</span> 
          <strong id="stat-acertos">0</strong> 
          <span style="font-size: 0.7em; color: gray; margin-left: 5px;">Acertos (1pt)</span>
        </li>
        <li>
          <span class="icone">‚úñÔ∏è</span> 
          <strong id="stat-erros">0</strong> 
          <span style="font-size: 0.7em; color: gray; margin-left: 5px;">Erros (0pt)</span>
        </li>
      </ul>
      
      <h3 class="font-russo titulo-azul mt-20">Aproveitamento</h3>
      <div class="aproveitamento-box mt-10">
        <span class="icone-grande" id="icone-aproveitamento">‚è≥</span>
        <p><strong id="texto-aproveitamento">Calculando...<br>--% de acerto</strong></p>
      </div>
      
      <hr class="linha-divisoria final-linha">
      
      <a href="perfil.html" class="perfil-rodape font-russo" style="text-decoration: none; display: flex;">
        <span class="icone">‚öôÔ∏è</span>
        <span class="texto-hover">Alterar Perfil</span>
      </a>
      
    </aside>

    <section class="cartao bg-escuro cartao-centro texto-centralizado animacao-suave">
      
      <div class="divisor-tracejado mb-10"></div>
      
      <p class="font-russo destaque-dourado brilha-suave">‚öúÔ∏è BRAH.LEAGUE ‚öúÔ∏è</p>
      <p class="font-russo destaque-dourado">‚öúÔ∏è TEMP 6 ‚öúÔ∏è</p>
      <p class="font-russo mb-10">- (SERIE A) -</p>
      
      <div class="divisor-tracejado mb-10"></div>
      
      <p class="status-texto font-russo destaque-status">üîÆ Status: RODADA 2 em andamento</p>
      
      <div class="divisor-tracejado mb-20 mt-10"></div>
      
      <div class="tabelona-container text-left">
        <p class="font-russo mb-10 text-left">‚¨áÔ∏è Tabelona ‚¨áÔ∏è</p>
        <ul class="tabelona-lista font-russo">
          <li class="item-interativo"><span class="quadrado verde"></span> 1¬∫ = GUIGO - 4</li>
          <li class="item-interativo"><span class="quadrado verde"></span> 2¬∫ = EMANUEL - 3</li>
          <li class="item-interativo"><span class="quadrado verde"></span> 3¬∫ = RODA - 1</li>
          <li class="item-interativo"><span class="quadrado amarelo"></span> 4¬∫ = RODRIGO P. - 1</li>
          <li class="item-interativo"><span class="quadrado amarelo"></span> 5¬∫ = STHEL - 1</li>
          <li class="item-interativo"><span class="quadrado laranja"></span> 6¬∫ = OLIVER - 1</li>
          <li class="item-interativo"><span class="quadrado vermelho"></span> 7¬∫ = ACACIO - 0</li>
          <li class="item-interativo"><span class="quadrado vermelho"></span> 8¬∫ = FERNANDO - 0</li>
        </ul>
      </div>
    </section>

    <aside class="coluna-destaques">
      
      <div class="cartao bg-escuro mb-20 animacao-suave">
        <h2 class="font-russo titulo-branco text-center mb-20">Destaques<br>rodada 1</h2>
        
        <div class="bloco-destaque mb-15">
          <h3 class="font-russo titulo-branco">Craque</h3>
          <p class="cor-emerald font-russo efeito-texto">Guigo 4pts</p>
        </div>
        
        <div class="bloco-destaque">
          <h3 class="font-russo titulo-branco">Bostinha</h3>
          <p class="cor-vermelha font-russo efeito-texto">Acacio 0pts</p>
          <p class="cor-vermelha font-russo efeito-texto">Fernando 0pts</p>
        </div>
      </div>

      <div class="cartao bg-escuro animacao-suave" style="position: relative; overflow: hidden; border: 1px solid var(--accent-cyan);">
    
    <div style="position: absolute; bottom: -20px; right: -20px; font-size: 100px; opacity: 0.05; pointer-events: none;">ü¶Ü</div>

    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
        <div style="width: 45px; height: 45px; background: var(--bg-dark); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; border: 2px solid var(--accent-cyan); box-shadow: 0 0 10px rgba(122, 30, 58, 0.4);">
            ü¶Ü
        </div>
        <div class="text-left">
            <h3 class="font-russo titulo-branco" style="font-size: 16px; margin: 0;">Pato Mestre</h3>
            <p style="color: var(--accent-cyan); font-size: 10px; font-weight: bold; margin: 0; letter-spacing: 1px;">CEO DA BRAH.BET</p>
        </div>
    </div>

    <div style="background: var(--bg-dark); padding: 12px; border-radius: 10px; border-left: 3px solid var(--accent-cyan); position: relative;">
        <p class="font-russo" style="font-size: 13px; color: var(--text-gray); line-height: 1.4; text-align: left;">
            "Fala, <span id="nomePatoMestre" style="color: var(--text-white);">Craque</span>! Trate de cravar esses palpites, n√£o me fa√ßa passar vergonha na Arena!"
        </p>
    </div>
</div>
      
    </aside>

  </main>
</body>
<script>
  // 1. Puxamos os dados exatamente como vamos salvar no login
  const nomeLogado = localStorage.getItem('nome_craque');
  const timeLogado = localStorage.getItem('time_craque');
  const fotoLogada = localStorage.getItem('foto_craque'); // <-- Puxa a foto!

  if (nomeLogado) {
    document.getElementById('textoNome').innerText = nomeLogado;
    
    if (timeLogado && timeLogado !== "undefined") {
      document.getElementById('textoTime').innerText = timeLogado;
    }

    // SE TIVER FOTO, SUBSTITUI A IMAGEM PADR√ÉO!
    if (fotoLogada && fotoLogada !== "undefined" && fotoLogada !== "null") {
      document.getElementById('fotoPerfil').src = fotoLogada;
    }

  } else {
    // window.location.href = 'login.html'; 
  }
  console.log("Nome encontrado no navegador:", nomeLogado);
  console.log("Time encontrado no navegador:", timeLogado);

  // 2. Se o nome existir, injeta na tela
  if (nomeLogado) {
    document.getElementById('textoNome').innerText = nomeLogado;

    // Injeta o primeiro nome do craque na fala do Pato
    const spanPato = document.getElementById('nomePatoMestre');
    if (spanPato && nomeLogado) {
        spanPato.innerText = nomeLogado.split(' ')[0]; 
    }
    
    // Se ele tiver um time, injeta tamb√©m
    if (timeLogado && timeLogado !== "undefined") {
      document.getElementById('textoTime').innerText = timeLogado;
    }
  } else {
    // Se n√£o achar ningu√©m, redireciona pro login para proteger a p√°gina!
    console.log("Ningu√©m logado! Bloqueando acesso...");
    // Remova as barras "//" da linha abaixo quando o login estiver 100% pronto
    // window.location.href = 'login.html'; 
  }

  //foto do user
  // Fun√ß√£o que roda quando o usu√°rio escolhe uma foto do computador/celular
async function salvarFoto() {
  const arquivo = document.getElementById('inputFoto').files[0];
  if (!arquivo) return;

  // Precisamos do e-mail do usu√°rio para saber quem est√° trocando a foto
  const emailLogado = localStorage.getItem('email_craque'); 
  if (!emailLogado) {
    alert("Erro: E-mail n√£o encontrado. Fa√ßa login novamente.");
    return;
  }

  // Isso aqui transforma a imagem em um texto Base64
  const reader = new FileReader();
  reader.onloadend = async function() {
    const fotoBase64 = reader.result;

    // Mostra a foto na tela na mesma hora
    document.getElementById('fotoPerfil').src = fotoBase64;

    try {
      // Manda a foto pro servidor
      const resposta = await fetch('http://localhost:3000/atualizar-foto', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          email: emailLogado, 
          foto_base64: fotoBase64 
        })
      });

      const resultado = await resposta.json();
      
      if (resposta.ok) {
        // Salva a foto na mem√≥ria do navegador para n√£o sumir quando atualizar a p√°gina
        localStorage.setItem('foto_craque', fotoBase64);
        console.log("Foto salva no banco de dados!");
      }
    } catch (erro) {
      console.error("Erro ao enviar foto:", erro);
    }
  };
  
  // Inicia a transforma√ß√£o da imagem
  reader.readAsDataURL(arquivo);
}

// Quando a p√°gina carregar, puxa a foto da mem√≥ria (adicione isso no seu script principal)
const fotoSalva = localStorage.getItem('foto_craque');
if (fotoSalva && fotoSalva !== "undefined" && fotoSalva !== "null") {
  document.getElementById('fotoPerfil').src = fotoSalva;
}

// FUN√á√ÉO PARA CALCULAR O DESEMPENHO E APROVEITAMENTO
  async function calcularDesempenho() {
    // Puxa o ID do usu√°rio que est√° no localStorage
    const idUsuario = localStorage.getItem('craqueId');
    if (!idUsuario) return;

    try {
      // Bate na nossa rota que j√° existe para pegar os palpites dele!
      const resposta = await fetch(`http://localhost:3000/meus-palpites/${idUsuario}`);
      const palpites = await resposta.json();

      let cravadas = 0;
      let acertos = 0;
      let erros = 0;
      let jogosFinalizados = 0;

      // Passa por cada palpite contando os pontos
      palpites.forEach(p => {
        // S√≥ conta os jogos que j√° foram encerrados pelo ADM (onde tem nota salva)
        if (p.pontos_obtidos !== null) { 
          jogosFinalizados++;
          if (p.pontos_obtidos === 3) cravadas++;
          else if (p.pontos_obtidos === 1) acertos++;
          else if (p.pontos_obtidos === 0) erros++;
        }
      });

      // 1. Atualiza a listinha de gols, acertos e erros na tela
      document.getElementById('stat-cravadas').innerText = cravadas;
      document.getElementById('stat-acertos').innerText = acertos;
      document.getElementById('stat-erros').innerText = erros;

      // 2. Calcula a porcentagem de acerto (Aproveitamento)
      if (jogosFinalizados > 0) {
        // Ele "acertou" se tirou 3 ou 1.
        const taxaAcerto = Math.round(((cravadas + acertos) / jogosFinalizados) * 100);
        
        let icone = "üëç";
        let frase = "Na m√©dia,";
        
        // Regras de zoeira/elogio baseadas na porcentagem!
        if (taxaAcerto >= 70) { 
          icone = "üî•"; 
          frase = "T√° voando!,"; 
        } else if (taxaAcerto >= 40) { 
          icone = "üëç"; 
          frase = "Bom jogador,"; 
        } else { 
          icone = "ü¶Ü"; 
          frase = "Pato master,"; 
        }

        document.getElementById('icone-aproveitamento').innerText = icone;
        document.getElementById('texto-aproveitamento').innerHTML = `${frase}<br>${taxaAcerto}% de acerto`;
      } else {
        document.getElementById('icone-aproveitamento').innerText = "‚öΩ";
        document.getElementById('texto-aproveitamento').innerHTML = `Sem jogos<br>encerrados ainda`;
      }

    } catch (erro) {
      console.error("Erro ao puxar o desempenho:", erro);
      document.getElementById('texto-aproveitamento').innerHTML = `Erro de conex√£o`;
    }
  }

  // Aciona o c√°lculo assim que a tela abre!
  calcularDesempenho();
  
</script>

</html>