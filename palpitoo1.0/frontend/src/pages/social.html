<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Palpitoo - Social</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Salsa&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>

  <header class="navbar">
    <a href="_index.html" class="logo-link">
    <img src="./img/pato.png" alt="Logo Palpitoo" class="logo-imagem">
</a>
    
    <nav>
      <ul class="nav-links">
        <li><a href="_index.html">In√≠cio</a></li> 
        <li><a href="ligas.html">Ligas</a></li> 
        <li><a href="palpites.html">Palpites</a></li>
        <li><a href="novidades.html">Novidades</a></li>
        <li><a href="social.html" class="ativo">Social</a></li>
        <li><a href="carreira.html">Carreira</a></li>
      </ul>
    </nav>
  </header>

  <main class="container-principal" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-top: 40px;">
    
    <section class="cartao bg-escuro animacao-suave">
      <div class="cabecalho-palpite mb-20 text-center">
        <h2 class="font-russo titulo-branco">Encontrar Craques</h2>
        <p class="subtitulo-tempo">Convoque mais rivais para a Brah.Bet</p>
      </div>

      <div class="divisor-tracejado mb-20"></div>

      <div class="form-group" style="display: flex; gap: 10px;">
        <input type="text" id="inputBusca" placeholder="Digite o nome..." style="margin-bottom: 0;">
        <button class="btn btn-salvar font-russo" onclick="buscarUsuarios()" style="margin-top: 0; padding: 0 20px;">Buscar</button>
      </div>

      <div id="lista-busca" class="mt-20">
        <p class="text-center text-gray-500 font-salsa">Pesquise por nome acima...</p>
      </div>
    </section>

    <section class="cartao bg-escuro animacao-suave">
      <div class="cabecalho-palpite mb-20 text-center">
        <h2 class="font-russo titulo-branco">Meus Amigos</h2>
        <p class="subtitulo-tempo">A tropa aben√ßoada pelo Pato Mestre</p>
      </div>

      <div class="divisor-tracejado mb-20"></div>

      <div id="lista-amigos">
        <p class="text-center text-gray-500 font-salsa">Carregando seus amigos... üîÑ</p>
      </div>
      
    </section>

  </main>

  <script>
    // Puxa o ID do usu√°rio logado
    const idLogado = localStorage.getItem('craqueId') || localStorage.getItem('id_craque');

    // 1. FUN√á√ÉO PARA BUSCAR USU√ÅRIOS NO SERVIDOR
    async function buscarUsuarios() {
        const termo = document.getElementById('inputBusca').value.trim();
        if (!termo) return alert("Digite um nome para buscar!");

        try {
            const resposta = await fetch(`http://localhost:3000/buscar-usuarios?nome=${termo}`);
            const usuarios = await resposta.json();
            
            const listaBusca = document.getElementById('lista-busca');
            listaBusca.innerHTML = '';

            if (usuarios.length === 0) {
                listaBusca.innerHTML = '<p class="text-center text-gray-500">Nenhum craque encontrado com esse nome. ü¶Ü</p>';
                return;
            }

            usuarios.forEach(u => {
                // N√£o mostra voc√™ mesmo na lista de busca
                if (u.id == idLogado) return;

                listaBusca.innerHTML += `
                    <div class="linha-jogo" style="grid-template-columns: auto 1fr auto; justify-content: start; border-bottom: 1px dashed var(--borda-divisoria); padding-bottom: 15px; margin-bottom: 15px;">
                        <img src="${u.foto_perfil || 'https://via.placeholder.com/50'}" alt="Foto" class="foto-perfil" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%;">
                        <div style="text-align: left; padding-left: 15px;">
                            <p class="font-russo text-white" style="font-size: 16px;">${u.nome}</p>
                            <p style="color: var(--text-gray); font-size: 12px;">${u.time_favorito || 'Sem Time'}</p>
                        </div>
                        <button class="btn btn-salvar font-russo" onclick="adicionarAmigo(${u.id})" style="padding: 8px 15px; font-size: 12px; background-color: var(--accent-cyan);">+ Add</button>
                    </div>
                `;
            });
        } catch (erro) {
            console.error("Erro na busca:", erro);
        }
    }

    // 2. FUN√á√ÉO PARA ADICIONAR UM AMIGO
    async function adicionarAmigo(idAmigo) {
        try {
            const resposta = await fetch('http://localhost:3000/adicionar-amigo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    usuario_id: idLogado, 
                    amigo_id: idAmigo 
                })
            });

            if (resposta.ok) {
                alert("‚úÖ Craque convocado para sua tropa!");
                carregarAmigos(); // Atualiza a lista de amigos na hora
            } else {
                alert("‚ùå Voc√™ j√° √© amigo deste jogador!");
            }
        } catch (erro) {
            console.error("Erro ao adicionar amigo:", erro);
        }
    }

    // 3. FUN√á√ÉO PARA CARREGAR A LISTA DE AMIGOS DO USU√ÅRIO
    async function carregarAmigos() {
        if (!idLogado) return;

        try {
            const resposta = await fetch(`http://localhost:3000/meus-amigos/${idLogado}`);
            const amigos = await resposta.json();
            
            const listaAmigos = document.getElementById('lista-amigos');
            listaAmigos.innerHTML = '';

            if (amigos.length === 0) {
                listaAmigos.innerHTML = '<p class="text-center text-gray-500 font-salsa">Voc√™ ainda n√£o tem amigos. Busque novos craques ao lado! ü¶Ü</p>';
                return;
            }

            amigos.forEach(a => {
                listaAmigos.innerHTML += `
                    <div class="linha-jogo" style="grid-template-columns: auto 1fr auto; justify-content: start; border-bottom: 1px dashed var(--borda-divisoria); padding-bottom: 15px; margin-bottom: 15px;">
                        <img src="${a.foto_perfil || 'https://via.placeholder.com/50'}" alt="Foto" class="foto-perfil" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%; border-color: var(--accent-green);">
                        <div style="text-align: left; padding-left: 15px;">
                            <p class="font-russo text-white" style="font-size: 16px;">${a.nome} <span style="font-size: 12px; color: var(--accent-green);">‚úîÔ∏è Seguidor</span></p>
                            <p style="color: var(--text-gray); font-size: 12px;">${a.time_favorito || 'Sem Time'}</p>
                        </div>
                        <button class="btn btn-cancelar font-russo" onclick="removerAmigo(${a.id})" style="padding: 8px 15px; font-size: 12px;" title="Remover Amigo">X</button>
                    </div>
                `;
            });
        } catch (erro) {
            console.error("Erro ao carregar amigos:", erro);
        }
    }

    // 4. FUN√á√ÉO PARA REMOVER UM AMIGO
    async function removerAmigo(idAmigo) {
        if (!confirm("Deseja mesmo remover este craque da sua lista?")) return;

        try {
            const resposta = await fetch('http://localhost:3000/remover-amigo', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    usuario_id: idLogado, 
                    amigo_id: idAmigo 
                })
            });

            if (resposta.ok) {
                carregarAmigos(); // Atualiza a lista na tela
            }
        } catch (erro) {
            console.error("Erro ao remover amigo:", erro);
        }
    }

    // Inicia a lista de amigos assim que a p√°gina abre
    carregarAmigos();
  </script>

</body>
</html>