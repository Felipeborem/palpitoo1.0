<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Palpitoo - Ligas e Palpites</title>
  <link rel="stylesheet" href="./css/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Salsa&display=swap" rel="stylesheet">
  <link rel="icon" href="./img/pato.png" type="image/png">

  <style>
    /* Estilos para as Abas */
    .tabs-principais { display: flex; gap: 10px; margin-bottom: 30px; justify-content: center; border-bottom: 2px solid var(--borda-divisoria); padding-bottom: 10px; }
    .tab-principal-btn { background: transparent; border: 1px solid var(--borda-divisoria); border-radius: 10px; color: var(--text-gray); font-size: 16px; padding: 10px 20px; cursor: pointer; font-family: 'Russo One', sans-serif; transition: all 0.2s; }
    .tab-principal-btn:hover { border-color: var(--accent-cyan); color: var(--text-white); }
    .tab-principal-btn.ativo { background: var(--accent-cyan); border-color: var(--accent-cyan); color: var(--text-white); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(122, 30, 58, 0.3); }
    .aba-conteudo { display: none; animation: fadeIn 0.3s ease-in-out; }
    .aba-conteudo.ativo { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <header class="navbar">
    <a href="index.html" class="logo-link"><img src="./img/pato.png" alt="Logo Palpitoo" class="logo-imagem"></a>
    <nav>
      <ul class="nav-links">
        <li><a href="index.html">In√≠cio</a></li> 
        <li><a href="ligas.html" class="ativo">Ligas</a></li> 
        <li><a href="palpites.html">Palpites</a></li>
        <li><a href="novidades.html">Novidades</a></li>
        <li><a href="social.html">Social</a></li>
        <li><a href="carreira.html">Carreira</a></li>
      </ul>
    </nav>
    <div class="navbar-user" id="navbar-user-area"></div>
  </header>

  <main class="container-principal" style="margin-top: 40px; max-width: 1000px; margin-left: auto; margin-right: auto;">
    
    <div class="text-center mb-20 animacao-suave">
      <h2 class="font-russo titulo-branco" style="font-size: 32px;">Suas <span style="color: var(--accent-cyan);">Ligas</span></h2>
      <p style="color: var(--text-gray); font-size: 16px;">Gerencie seus campeonatos e fa√ßa seus palpites no mesmo lugar</p>
    </div>

    <div class="tabs-principais animacao-suave">
      <button class="tab-principal-btn ativo" onclick="mudarAba('aba-ligas', this)" id="btn-aba-ligas">üèÜ Minhas Ligas</button>
      <button class="tab-principal-btn" onclick="mudarAba('aba-palpites', this)" id="btn-aba-palpites">‚öΩ Jogos & Palpites</button>
    </div>

    <div id="aba-ligas" class="aba-conteudo ativo">
      
      <div class="text-center mb-20">
        <button class="btn btn-primary font-russo" onclick="criarLiga()" style="width: auto; padding: 12px 30px; font-size: 14px; background-color: var(--accent-cyan);">üëë + Criar Nova Liga</button>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">
        
        <section class="cartao bg-escuro">
          <h3 class="font-russo titulo-branco mb-15" style="font-size: 20px;">üèÜ Meus Campeonatos</h3>
          <div class="divisor-tracejado mb-20"></div>
          <ul id="lista-ligas-ativas" style="list-style: none; padding: 0;">
            <li class="text-center text-gray-400 font-russo py-4">Buscando... üîÑ</li>
          </ul>
        </section>

        <section class="cartao bg-escuro">
          <h3 class="font-russo titulo-branco mb-15" style="font-size: 20px;">üåç Explorar Ligas (Vitrine)</h3>
          <div class="divisor-tracejado mb-20"></div>
          <p style="color: var(--text-gray); font-size: 13px; margin-bottom: 15px;">Ligas p√∫blicas dispon√≠veis para voc√™ entrar com 1 clique:</p>
          
          <ul id="lista-ligas-disponiveis" style="list-style: none; padding: 0;">
            <li class="text-center text-gray-400 font-russo py-4">Buscando ligas... üîÑ</li>
          </ul>

          <div class="divisor-tracejado mb-20" style="margin-top: 20px;"></div>
          <p style="color: var(--text-gray); font-size: 12px; margin-bottom: 10px;">Ou entre com um c√≥digo privado:</p>
          <div class="form-group" style="display: flex; gap: 10px; margin-bottom: 0;">
            <input type="text" id="codigoLiga" placeholder="Ex: X7B9KQ" style="margin-bottom: 0; text-transform: uppercase;">
            <button class="btn btn-salvar font-russo" onclick="entrarNaLigaCodigo()" style="margin-top: 0; padding: 0 20px;">Entrar</button>
          </div>
        </section>

      </div>
    </div>

    <div id="aba-palpites" class="aba-conteudo">
      <section class="cartao bg-escuro text-center">
        <div id="alerta-sem-liga" style="display: block; padding: 40px 20px;">
          <h3 class="font-russo titulo-branco mb-15">Nenhuma Liga Selecionada ‚ö†Ô∏è</h3>
          <p style="color: var(--text-gray); margin-bottom: 20px;">V√° na aba "Minhas Ligas" e clique em "Ver Jogos" para fazer seus palpites.</p>
          <button class="btn btn-primary" onclick="mudarAba('aba-ligas', document.getElementById('btn-aba-ligas'))" style="width: auto; padding: 10px 20px;">Ir para Minhas Ligas</button>
        </div>
        <div id="area-palpites" style="display: none;">
          <h3 class="font-russo titulo-branco mb-10">Palpites: <span id="nome-liga-ativa" style="color: var(--accent-cyan);">Liga XYZ</span></h3>
          <div class="divisor-tracejado mb-20"></div>
          <p style="color: var(--text-gray);">Listagem de jogos para palpitar aparecer√° aqui...</p>
        </div>
      </section>
    </div>

  </main>

  <script>
    const idUsuario = localStorage.getItem('craqueId') || localStorage.getItem('id_craque'); 
    if (!idUsuario) window.location.href = 'login.html'; 

    function mudarAba(idAba, btn) {
      document.querySelectorAll('.aba-conteudo').forEach(aba => aba.classList.remove('ativo'));
      document.querySelectorAll('.tab-principal-btn').forEach(b => b.classList.remove('ativo'));
      document.getElementById(idAba).classList.add('ativo');
      btn.classList.add('ativo');
      if(idAba === 'aba-palpites') verificarLigaAtiva();
    }

    // ==========================================
    // CARREGAR MEUS CAMPEONATOS
    // ==========================================
    async function carregarLigas() {
      try {
        const resposta = await fetch(`https://palpitoo-api.onrender.com/minhas-ligas/${idUsuario}`);
        const ligas = await resposta.json();
        const ul = document.getElementById('lista-ligas-ativas');
        ul.innerHTML = ''; 

        if (ligas.length === 0) {
          ul.innerHTML = '<li class="text-center" style="color: var(--text-gray); padding: 20px 0;">Voc√™ n√£o participa de nenhuma liga ainda.</li>';
          return;
        }

        ligas.forEach(liga => {
          ul.innerHTML += `
            <li class="cartao bg-dark" style="padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--accent-cyan);">
              <h4 class="font-russo text-white" style="font-size: 16px; margin-bottom: 5px;">‚öúÔ∏è ${liga.nome}</h4>
              <p style="color: var(--text-gray); font-size: 11px; margin-bottom: 10px;">C√≥d: ${liga.codigo_convite}</p>
              <button onclick="selecionarLiga(${liga.id}, '${liga.nome}')" class="btn btn-salvar font-russo" style="width: 100%; padding: 8px; font-size: 12px;">Ver Jogos ‚öΩ</button>
            </li>
          `;
        });
      } catch (erro) { console.error(erro); }
    }
// ==========================================
    // CARREGAR VITRINE DE LIGAS (Para Entrar)
    // ==========================================
    async function carregarLigasDisponiveis() {
      const ul = document.getElementById('lista-ligas-disponiveis');
      
      try {
        const resposta = await fetch(`https://palpitoo-api.onrender.com/ligas-disponiveis/${idUsuario}`);
        
        // Se a Render der erro 404, a gente j√° trava aqui e avisa o usu√°rio
        if (!resposta.ok) {
            throw new Error(`Erro do servidor: ${resposta.status}`);
        }

        const ligas = await resposta.json();
        ul.innerHTML = ''; 

        if (ligas.length === 0) {
          ul.innerHTML = '<li class="text-center" style="color: var(--text-gray); font-size: 12px; padding: 20px 0;">Nenhuma nova liga dispon√≠vel no momento.</li>';
          return;
        }

        ligas.forEach(liga => {
          ul.innerHTML += `
            <li class="cartao" style="padding: 12px; margin-bottom: 10px; background: #1a0a10; border: 1px solid var(--borda-divisoria); display: flex; justify-content: space-between; align-items: center;">
              <h4 class="font-russo text-white" style="font-size: 14px; margin: 0;">${liga.nome}</h4>
              <button onclick="entrarNaLigaClique(${liga.id})" class="btn font-russo" style="background: #2ecc71; color: white; border: none; padding: 6px 12px; font-size: 11px; cursor: pointer; border-radius: 6px;">Entrar +</button>
            </li>
          `;
        });
      } catch (erro) { 
        console.error("Deu ruim na busca:", erro); 
        // Em vez de carregar para sempre, mostra o erro na tela!
        ul.innerHTML = '<li class="text-center font-russo" style="color: #e74c3c; font-size: 12px; padding: 20px 0;">‚ùå Erro ao buscar ligas. O servidor est√° atualizando?</li>';
      }
    }
    // ==========================================
    // ENTRAR NA LIGA AO CLICAR NO BOT√ÉO VERDE
    // ==========================================
    async function entrarNaLigaClique(idLiga) {
      try {
        const resposta = await fetch('https://palpitoo-api.onrender.com/entrar-liga-clique', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ liga_id: idLiga, usuario_id: idUsuario })
        });
        const resultado = await resposta.json();
        if (resposta.ok) {
          alert(resultado.mensagem);
          // Atualiza as duas listas! Tira da vitrine e joga pros "Meus Campeonatos"
          carregarLigas(); 
          carregarLigasDisponiveis(); 
        } else {
          alert("‚ùå " + resultado.erro);
        }
      } catch (erro) { console.error(erro); }
    }

    // Entrar por C√≥digo (Modo Antigo)
    async function entrarNaLigaCodigo() {
      const codigo = document.getElementById('codigoLiga').value.trim().toUpperCase();
      if (!codigo) return alert("Digite o c√≥digo.");
      try {
        const resposta = await fetch('https://palpitoo-api.onrender.com/entrar-liga', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ codigo_convite: codigo, usuario_id: idUsuario })
        });
        const res = await resposta.json();
        if (resposta.ok) {
          alert("‚úÖ " + res.mensagem);
          document.getElementById('codigoLiga').value = '';
          carregarLigas();
          carregarLigasDisponiveis();
        } else { alert("‚ùå " + res.erro); }
      } catch (err) { console.error(err); }
    }

    // Criar Liga
    async function criarLiga() {
      const nomeLiga = prompt("Nome da sua nova Liga:");
      if (!nomeLiga || nomeLiga.trim() === "") return;
      try {
        const resposta = await fetch('https://palpitoo-api.onrender.com/criar-liga', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nome_liga: nomeLiga.trim(), dono_id: idUsuario })
        });
        const res = await resposta.json();
        if (resposta.ok) {
          alert(`‚úÖ Criada com sucesso!\nC√≥digo: ${res.liga.codigo_convite}`);
          carregarLigas();
        } else { alert("‚ùå " + res.erro); }
      } catch (err) { console.error(err); }
    }

    function selecionarLiga(idDaLiga, nomeDaLiga) {
      localStorage.setItem('liga_ativa_id', idDaLiga);
      localStorage.setItem('liga_ativa_nome', nomeDaLiga);
      mudarAba('aba-palpites', document.getElementById('btn-aba-palpites'));
    }

    function verificarLigaAtiva() {
      const ligaAtivaId = localStorage.getItem('liga_ativa_id');
      const ligaAtivaNome = localStorage.getItem('liga_ativa_nome');
      if (ligaAtivaId) {
        document.getElementById('alerta-sem-liga').style.display = 'none';
        document.getElementById('area-palpites').style.display = 'block';
        document.getElementById('nome-liga-ativa').innerText = ligaAtivaNome;
      } else {
        document.getElementById('alerta-sem-liga').style.display = 'block';
        document.getElementById('area-palpites').style.display = 'none';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      carregarLigas();
      carregarLigasDisponiveis(); // <-- Chama a fun√ß√£o nova pra carregar a vitrine!
    });

    // Navbar config
    (function() {
      const nome = localStorage.getItem('nome_craque') || '';
      const foto = localStorage.getItem('foto_craque');
      const userArea = document.getElementById('navbar-user-area');
      if (!userArea) return;
      if (nome) {
        const initials = encodeURIComponent(nome.split(' ')[0]);
        const src = (foto && foto !== 'null' && foto !== 'undefined') ? foto : `https://ui-avatars.com/api/?name=${initials}&background=7A1E3A&color=fff&size=36`;
        userArea.innerHTML = `<a href="perfil.html"><img src="${src}" alt="${nome}" class="navbar-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${initials}&background=7A1E3A&color=fff&size=36'"></a>
          <button class="btn-logout" onclick="fazerLogout()">Sair</button>`;
      }
    })();
    function fazerLogout() { localStorage.clear(); window.location.href = 'index.html'; }
  </script>
</body>
</html>