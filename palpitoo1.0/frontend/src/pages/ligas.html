<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Palpitoo - Ligas</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Salsa&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>

  <header class="navbar">
    <a href="_index.html" class="logo-link">
    <img src="./img/pato.png" alt="Logo Palpitoo" class="logo-imagem">
</a>
    
    <nav>
      <ul class="nav-links">
        <li><a href="_index.html">In√≠cio</a></li> 
        <li><a href="minhaliga.html" class="ativo">Ligas</a></li> 
        <li><a href="palpites.html">Palpites</a></li>
        <li><a href="novidades.html">Novidades</a></li>
        <li><a href="social.html">Social</a></li>
        <li><a href="carreira.html">Carreira</a></li>
      </ul>
    </nav>
  </header>

  <main class="container-principal" style="margin-top: 40px;">
    
    <div class="text-center mb-20 animacao-suave">
      <h2 class="font-russo titulo-branco" style="font-size: 32px;">Suas <span style="color: var(--accent-cyan);">Ligas</span></h2>
      <p style="color: var(--text-gray); font-size: 16px;">Gerencie seus campeonatos e crie novas disputas</p>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">
      
      <section class="cartao bg-escuro animacao-suave">
        <h3 class="font-russo titulo-branco mb-15" style="font-size: 20px;">üèÜ Campeonatos Ativos</h3>
        <div class="divisor-tracejado mb-20"></div>

        <ul id="lista-ligas-ativas" style="list-style: none; padding: 0;">
          <li class="text-center text-gray-400 font-russo py-4">Buscando seus campeonatos... üîÑ</li>
        </ul>
      </section>

      <section style="display: flex; flex-direction: column; gap: 20px;">
        
        <div class="cartao bg-escuro animacao-suave">
          <h3 class="font-russo titulo-branco mb-10" style="font-size: 20px;">üîë Entrar em uma Liga</h3>
          <p style="color: var(--text-gray); font-size: 12px; margin-bottom: 15px;">Recebeu um c√≥digo de convite? Digite abaixo para entrar na disputa.</p>
          
          <div class="form-group" style="display: flex; gap: 10px; margin-bottom: 0;">
            <input type="text" id="codigoLiga" placeholder="Ex: X7B9KQ" style="margin-bottom: 0; text-transform: uppercase;">
            <button class="btn btn-salvar font-russo" onclick="entrarNaLiga()" style="margin-top: 0; padding: 0 20px;">Entrar</button>
          </div>
        </div>

        <div class="cartao bg-escuro animacao-suave" style="text-align: center; border: 2px dashed var(--accent-cyan); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px 20px;">
          <div style="font-size: 40px; margin-bottom: 15px;">üëë</div>
          <h3 class="font-russo titulo-branco mb-10" style="font-size: 20px;">Seja o Dono da Liga</h3>
          <p style="color: var(--text-gray); font-size: 12px; margin-bottom: 20px; max-width: 250px;">Crie seu pr√≥prio campeonato, defina as regras e convide a rapaziada.</p>
          
          <button class="btn btn-primary font-russo" onclick="criarLiga()" style="width: auto; padding: 12px 30px; font-size: 14px; background-color: var(--accent-cyan);">+ Criar Nova Liga</button>
        </div>

      </section>

    </div>
  </main>

  <script>
    // 1. Puxa o ID do usu√°rio (o mesmo que a gente usou no Ranking e Desempenho)
    const idUsuario = localStorage.getItem('craqueId') || localStorage.getItem('id_craque'); 

    if (!idUsuario) {
      console.log("Usu√°rio n√£o logado! Bloqueando acesso...");
      // Descomente a linha abaixo quando o sistema de login estiver 100% blindado
      // window.location.href = 'login.html'; 
    }

    // -------------------------------------------------------------------------
    // FUN√á√ÉO: CARREGAR AS LIGAS QUE O USU√ÅRIO J√Å PARTICIPA
    async function carregarLigas() {
      if (!idUsuario) return;

      try {
        const resposta = await fetch(`http://localhost:3000/minhas-ligas/${idUsuario}`);
        const ligas = await resposta.json();
        
        const ul = document.getElementById('lista-ligas-ativas');
        ul.innerHTML = ''; // Limpa a mensagem de carregamento

        if (ligas.length === 0) {
          ul.innerHTML = '<li class="text-center" style="color: var(--text-gray); font-family: \'Russo One\', sans-serif; padding: 20px 0;">Voc√™ ainda n√£o participa de nenhuma liga. Crie ou entre em uma! ü¶Ü</li>';
          return;
        }

        ligas.forEach(liga => {
          // Checa se o usu√°rio √© o dono da liga para colocar uma tag diferente
          const ehDono = liga.dono_id == idUsuario;
          
          let tagBadge = '';
          if (ehDono) {
            tagBadge = `<span style="background: var(--accent-cyan); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;">DONO DA LIGA</span>`;
          } else {
            tagBadge = `<span style="background: var(--borda-divisoria); color: var(--text-gray); padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;">PARTICIPANTE</span>`;
          }

          // Monta o "cart√£ozinho" da liga
          ul.innerHTML += `
            <li class="cartao bg-dark animacao-suave" style="padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--accent-cyan); background: var(--bg-dark);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h4 class="font-russo text-white" style="font-size: 16px; margin: 0;">‚öúÔ∏è ${liga.nome}</h4>
                ${tagBadge}
              </div>
              <p style="color: var(--text-gray); font-size: 12px; margin-bottom: 10px;">
                C√≥digo de Convite: <strong style="color: white; font-size: 14px; letter-spacing: 1px;">${liga.codigo_convite}</strong>
              </p>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <p class="font-russo" style="color: var(--text-gray); font-size: 14px; margin: 0;">Geral</p>
                <a href="ranking.html" class="btn btn-salvar font-russo" style="padding: 6px 12px; font-size: 12px; margin: 0; text-decoration: none; display: inline-block;">Ver Liga</a>
              </div>
            </li>
          `;
        });
      } catch (erro) {
        console.error("Erro ao carregar as ligas:", erro);
      }
    }

    // -------------------------------------------------------------------------
    // FUN√á√ÉO: ENTRAR EM UMA LIGA USANDO O C√ìDIGO
    async function entrarNaLiga() {
      const codigo = document.getElementById('codigoLiga').value.trim().toUpperCase();
      
      if (!codigo) {
        alert("P√¥, craque! Digita um c√≥digo v√°lido a√≠.");
        return;
      }
      
      try {
        const resposta = await fetch('http://localhost:3000/entrar-liga', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            codigo_convite: codigo, 
            usuario_id: idUsuario 
          })
        });

        const resultado = await resposta.json();

        if (resposta.ok) {
          alert("‚úÖ " + resultado.mensagem);
          document.getElementById('codigoLiga').value = '';
          carregarLigas(); // Atualiza a lista na mesma hora!
        } else {
          alert("‚ùå " + resultado.erro);
        }
      } catch (erro) {
        console.error(erro);
        alert("Erro ao conectar com o servidor.");
      }
    }

    // -------------------------------------------------------------------------
    // FUN√á√ÉO: CRIAR UMA NOVA LIGA
    async function criarLiga() {
      const nomeLiga = prompt("Qual vai ser o nome da sua nova Liga? (Ex: Liga dos Campe√µes da Firma)");
      
      if (!nomeLiga || nomeLiga.trim() === "") return; // Se o cara cancelar, n√£o faz nada

      try {
        const resposta = await fetch('http://localhost:3000/criar-liga', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            nome_liga: nomeLiga.trim(), 
            dono_id: idUsuario 
          })
        });

        const resultado = await resposta.json();

        if (resposta.ok) {
          alert(`‚úÖ ${resultado.mensagem}\n\nMande este c√≥digo para os seus amigos entrarem: ${resultado.liga.codigo_convite}`);
          carregarLigas(); // Atualiza a lista para a nova liga aparecer na hora!
        } else {
          alert("‚ùå " + resultado.erro);
        }
      } catch (erro) {
        console.error(erro);
        alert("Erro ao criar a liga no servidor.");
      }
    }

    // Aciona a busca das ligas assim que a tela abre!
    carregarLigas();
  </script>

</body>
</html>