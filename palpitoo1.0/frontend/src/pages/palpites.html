<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Palpitoo - Palpites</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Salsa&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>

  <header class="navbar">
    <a href="_index.html" class="logo-link">
    <img src="./img/pato.png" alt="Logo Palpitoo" class="logo-imagem">
</a>
    <nav>
      <ul class="nav-links">
        <li><a href="_index.html">In√≠cio</a></li> 
        <li><a href="ligas.html">Ligas</a></li>
        <li><a href="palpites.html" class="ativo">Palpites</a></li>
        <li><a href="novidades.html">Novidades</a></li>
        <li><a href="social.html">Social</a></li>
        <li><a href="carreira.html">Carreira</a></li>
      </ul>
    </nav>
  </header>

  <main class="container-principal container-palpites">
    
    <section class="cartao bg-escuro cartao-palpite animacao-suave">
      
      <div class="cabecalho-palpite mb-20">
        <h2 class="font-russo titulo-branco text-center">Palpites Brah.bet</h2>
        <p class="subtitulo-tempo text-center">Deixe seus palpites para os pr√≥ximos jogos</p>
      </div>

      <div class="lista-jogos" id="container-jogos">
        <p class="text-center text-white font-russo mt-10">Buscando tabela de jogos... üîÑ</p>
      </div>

      <div class="botoes-acao mt-20">
        <button class="btn btn-cancelar font-russo" onclick="limparPalpites()">Limpar</button>
        <button class="btn btn-salvar font-russo" onclick="enviarTodosPalpites()">Salvar Palpites</button>
      </div>

    </section>

    <section class="cartao bg-escuro cartao-palpite animacao-suave mt-20">
      <div class="cabecalho-palpite mb-20">
        <h2 class="font-russo titulo-branco text-center">Meus Palpites Registrados</h2>
        <p class="subtitulo-tempo text-center">Acompanhe o andamento das partidas</p>
      </div>
      
      <div class="lista-jogos" id="resumo-palpites">
        <p class="text-center text-white font-russo mt-10">Buscando seus comprovantes...</p>
      </div>
    </section>

  </main>

<script>
  let jogosCarregados = [];

  // 1. FUN√á√ÉO QUE BUSCA E DESENHA OS JOGOS SEPARADOS POR RODADA
async function carregarJogos() {
    try {
      const resposta = await fetch('http://localhost:3000/jogos');
      jogosCarregados = await resposta.json();
      
      const container = document.getElementById('container-jogos');
      container.innerHTML = ''; 

      if (jogosCarregados.length === 0) {
        container.innerHTML = '<p class="text-center text-white font-russo mt-10">Nenhum jogo liberado ainda.</p>';
        return;
      }

      const jogosPorRodada = {};
      jogosCarregados.forEach(jogo => {
        const rodada = jogo.rodada || 1;
        if (!jogosPorRodada[rodada]) jogosPorRodada[rodada] = [];
        jogosPorRodada[rodada].push(jogo);
      });

      for (const rodada in jogosPorRodada) {
        container.innerHTML += `
          <div class="text-center mt-10 mb-5" style="border-bottom: 2px dashed var(--borda-divisoria); padding-bottom: 10px;">
            <h3 class="font-russo" style="color: var(--accent-cyan); font-size: 20px;">üèÜ RODADA ${rodada}</h3>
          </div>
        `;

        jogosPorRodada[rodada].forEach(jogo => {
          // NOVA L√ìGICA: Se o jogo acabou, desabilita o campo e muda a cor
          const jogoFinalizado = jogo.status.toLowerCase() === "finalizado";
          const estiloInput = jogoFinalizado ? "opacity: 0.5; cursor: not-allowed; border-color: #f87171;" : "";
          const propDisabled = jogoFinalizado ? "disabled" : "";

          container.innerHTML += `
            <div class="linha-jogo" style="${jogoFinalizado ? 'filter: grayscale(0.8);' : ''}">
              <span class="nome-time time-casa">${jogo.time_casa}</span>
              
              <div class="area-placar">
                <input type="number" id="casa_${jogo.id_jogo}" 
                       class="input-placar font-russo" 
                       placeholder="0" min="0" 
                       style="${estiloInput}" ${propDisabled}>
                
                <span class="versus">x</span>
                
                <input type="number" id="fora_${jogo.id_jogo}" 
                       class="input-placar font-russo" 
                       placeholder="0" min="0" 
                       style="${estiloInput}" ${propDisabled}>
              </div>
              
              <span class="nome-time time-fora text-left">${jogo.time_fora}</span>
            </div>
            ${jogoFinalizado ? '<p class="text-center text-red-500 font-russo" style="font-size: 9px; margin-top: -10px;">üîí Palpites encerrados para este jogo</p>' : ''}
          `;
        });
      }
      puxarPalpitesSalvos();
    } catch (erro) {
      console.error("Erro:", erro);
    }
  }
  // 2. FUN√á√ÉO QUE RECOLHE OS DADOS DIGITADOS
  async function enviarTodosPalpites() {
    const idUsuario = localStorage.getItem('craqueId') || localStorage.getItem('id_craque'); 
    
    if (!idUsuario) {
      alert("Voc√™ precisa estar logado para salvar seus palpites!");
      return;
    }

    const palpitesParaSalvar = [];

    jogosCarregados.forEach(jogo => {
      const inputCasa = document.getElementById(`casa_${jogo.id_jogo}`).value;
      const inputFora = document.getElementById(`fora_${jogo.id_jogo}`).value;

      if (inputCasa !== "" && inputFora !== "") {
        palpitesParaSalvar.push({
          id_jogo: jogo.id_jogo,
          id_usuario: idUsuario,
          gols_casa: parseInt(inputCasa),
          gols_fora: parseInt(inputFora)
        });
      }
    });

    if (palpitesParaSalvar.length === 0) {
      alert("Preencha pelo menos um placar para salvar!");
      return;
    }

    try {
      const resposta = await fetch('http://localhost:3000/palpites', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ palpites: palpitesParaSalvar }) 
      });

      const resultado = await resposta.json();

      if (resposta.ok) {
        alert("‚úÖ " + resultado.mensagem);
        // Atualiza os comprovantes logo ap√≥s salvar!
        puxarPalpitesSalvos();
      } else {
        alert("‚ùå Ops: " + resultado.erro);
      }
    } catch (erro) {
      console.error("Erro na conex√£o:", erro);
      alert("Servidor desligado! Verifique o terminal.");
    }
  }

  // 3. FUN√á√ÉO DO BOT√ÉO LIMPAR
  function limparPalpites() {
    const inputs = document.querySelectorAll('.input-placar');
    inputs.forEach(input => input.value = '');
  }

  // 4. FUN√á√ÉO QUE PREENCHE OS INPUTS E GERA O RESUMO (AGORA COM RODADAS!)
  async function puxarPalpitesSalvos() {
    const idUsuario = localStorage.getItem('craqueId') || localStorage.getItem('id_craque');
    if (!idUsuario) return;

    try {
      const resposta = await fetch(`http://localhost:3000/meus-palpites/${idUsuario}`);
      const meusPalpites = await resposta.json();

      const containerResumo = document.getElementById('resumo-palpites');
      containerResumo.innerHTML = ''; 

      if (meusPalpites.length === 0) {
        containerResumo.innerHTML = '<p class="text-center text-gray-400 font-russo mt-10">Voc√™ ainda n√£o deu nenhum palpite.</p>';
        return;
      }

      // PREENCHE AS CAIXINHAS L√Å EM CIMA PARA EDI√á√ÉO
      meusPalpites.forEach(palpite => {
        const inputCasa = document.getElementById(`casa_${palpite.jogo_id}`);
        const inputFora = document.getElementById(`fora_${palpite.jogo_id}`);
        if (inputCasa && inputFora) {
          inputCasa.value = palpite.gols_casa_palpite;
          inputFora.value = palpite.gols_fora_palpite;
        }
      });

      // AGRUPANDO OS COMPROVANTES POR RODADA TAMB√âM
      const comprovantesPorRodada = {};
      
      meusPalpites.forEach(palpite => {
        const jogo = jogosCarregados.find(j => j.id_jogo === palpite.jogo_id);
        if (jogo) {
          const rodada = jogo.rodada || 1;
          if (!comprovantesPorRodada[rodada]) comprovantesPorRodada[rodada] = [];
          
          comprovantesPorRodada[rodada].push({ palpite, jogo });
        }
      });

      // DESENHANDO OS COMPROVANTES
      for (const rodada in comprovantesPorRodada) {
        containerResumo.innerHTML += `
          <div class="text-center mt-10 mb-5">
            <h3 class="font-russo" style="color: var(--text-gray); font-size: 16px;">‚ñ∂ RODADA ${rodada}</h3>
          </div>
        `;

        comprovantesPorRodada[rodada].forEach(item => {
          const { palpite, jogo } = item;
          
          let corStatus = "color: #4ade80;"; // Verde para aberto
          if (jogo.status.toLowerCase() === "em andamento") corStatus = "color: #facc15;"; // Amarelo
          if (jogo.status.toLowerCase() === "finalizado") corStatus = "color: #f87171;"; // Vermelho

          containerResumo.innerHTML += `
            <div class="linha-jogo" style="margin-bottom: 5px;">
              <span class="nome-time time-casa">${jogo.time_casa}</span>
              
              <div style="display: flex; flex-direction: column; align-items: center;">
                <span class="font-russo" style="${corStatus} font-size: 10px; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 1px;">
                  ‚óè ${jogo.status}
                </span>
                
                <div class="area-placar" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                  <div class="input-placar font-russo" style="display: flex; align-items: center; justify-content: center; background-color: #1f2937; color: white; border: 1px solid #374151;">
                    ${palpite.gols_casa_palpite}
                  </div>
                  <span class="versus">x</span>
                  <div class="input-placar font-russo" style="display: flex; align-items: center; justify-content: center; background-color: #1f2937; color: white; border: 1px solid #374151;">
                    ${palpite.gols_fora_palpite}
                  </div>
                </div>
              </div>
              
              <span class="nome-time time-fora text-left">${jogo.time_fora}</span>
            </div>
            <div style="border-bottom: 1px dashed #333; margin: 15px 10% 25px 10%;"></div>
          `;
        });
      }
      
    } catch (erro) {
      console.error("Erro ao puxar os palpites:", erro);
    }
  }

  // LIGA O MOTOR!
  carregarJogos();
</script>
<script src="main.js"></script>
</body>
</html>