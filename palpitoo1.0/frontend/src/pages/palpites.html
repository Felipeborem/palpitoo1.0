<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Palpitoo - Palpites</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Salsa&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>

  <header class="navbar">
    <a href="http://localhost:5501/palpitoo1.0/frontend/src/pages/inicio.html" style="text-decoration: none; color: inherit;">
        <div class="logo-container">
            <div class="logo-icon">P</div>
            <h1 class="logo-text font-russo">Palpi<span style="color: var(--accent-cyan);">too</span></h1>
        </div>
    </a>
    <nav>
      <ul class="nav-links">
        <li><a href="_index.html">in√≠cio</a></li> 
        <li><a href="ligas.html">Ligas</a></li>
        <li><a href="palpites.html" class="ativo">Palpites</a></li>
        <li><a href="novidades.html">Novidades</a></li>
        <li><a href="social.html">Social</a></li>
        <li><a href="carreira.html">Carreira</a></li>
       
      </ul>
    </nav>
  </header>

  <main class="container-principal container-palpites">
    
    <section class="cartao bg-escuro cartao-palpite animacao-suave">
      
      <div class="cabecalho-palpite mb-20">
        <h2 class="font-russo titulo-branco text-center">Palpites Brah.bet</h2>
        <p class="subtitulo-tempo text-center">‚è≥ 3h at√© fim dos palpites</p>
      </div>


<!-- DIV PRINCIPAL DE LISTAS DE JOGOS-->
      <div class="lista-jogos" id="container-jogos">
        <div class="skeleton-box">
          <div class="skeleton-text right"></div>
          <div class="skeleton-placar"></div>
          <div class="skeleton-text left"></div>
        </div>
        <div class="skeleton-box">
          <div class="skeleton-text right"></div>
          <div class="skeleton-placar"></div>
          <div class="skeleton-text left"></div>
        </div>
        <div class="skeleton-box" style="border-bottom: none;">
          <div class="skeleton-text right"></div>
          <div class="skeleton-placar"></div>
          <div class="skeleton-text left"></div>
        </div>
      </div>

      <div class="botoes-acao mt-20">
        <button class="btn btn-cancelar font-russo" onclick="limparPalpites()">Limpar</button>
        <button class="btn btn-salvar font-russo" onclick="enviarTodosPalpites()">Salvar Palpites</button>
      </div>

    </section>


<!-- 2¬∞ CABE√áALHO - PALPITES E ANDAMENTO DOS JOGOS DO USER-->
    <section class="cartao bg-escuro cartao-palpite animacao-suave mt-20">
      <div class="cabecalho-palpite mb-20">
        <h2 class="font-russo titulo-branco text-center">Meus Palpites Registrados</h2>
        <p class="subtitulo-tempo text-center">Acompanhe o andamento das partidas</p>
      </div>
      
      <div class="lista-jogos" id="resumo-palpites">
        <p class="text-center text-white font-russo mt-10">Buscando seus comprovantes...</p>
      </div>
    </section>

  </main>
<script>
  // Vari√°vel global para lembrarmos quais jogos est√£o na tela
  let jogosCarregados = [];

  // 1. FUN√á√ÉO QUE BUSCA E DESENHA OS JOGOS
  async function carregarJogos() {
    try {
      const resposta = await fetch('http://localhost:3000/jogos');
      jogosCarregados = await resposta.json();
      
      const container = document.getElementById('container-jogos');
      container.innerHTML = ''; // Limpa a mensagem de carregando

      if (jogosCarregados.length === 0) {
        container.innerHTML = '<p class="text-center text-white font-russo mt-10">Nenhum jogo liberado ainda.</p>';
        return;
      }

      // Desenha o HTML usando as SUAS classes CSS para cada jogo do banco
      jogosCarregados.forEach(jogo => {
        container.innerHTML += `
          <div class="linha-jogo">
            <span class="nome-time time-casa">${jogo.time_casa}</span>
            
            <div class="area-placar">
              <input type="number" id="casa_${jogo.id_jogo}" class="input-placar font-russo" placeholder="0" min="0">
              <span class="versus">x</span>
              <input type="number" id="fora_${jogo.id_jogo}" class="input-placar font-russo" placeholder="0" min="0">
            </div>
            
            <span class="nome-time time-fora text-left">${jogo.time_fora}</span>
          </div>
        `;
      puxarPalpitesSalvos()
      });
    } catch (erro) {
      console.error("Erro ao buscar jogos:", erro);
      document.getElementById('container-jogos').innerHTML = '<p class="text-center text-red-500 font-russo mt-10">Erro ao conectar com o servidor.</p>';
    }
  }

  // 2. FUN√á√ÉO QUE RECOLHE OS DADOS DIGITADOS
  async function enviarTodosPalpites() {
    // Puxa o ID do usu√°rio que guardamos no Login!
    const idUsuario = localStorage.getItem('craqueId'); 
    
    if (!idUsuario) {
      alert("Voc√™ precisa estar logado para salvar seus palpites!");
      return;
    }

    const palpitesParaSalvar = [];

    // Passa por todos os jogos que est√£o na tela
    jogosCarregados.forEach(jogo => {
      const inputCasa = document.getElementById(`casa_${jogo.id_jogo}`).value;
      const inputFora = document.getElementById(`fora_${jogo.id_jogo}`).value;

      // S√≥ cria o palpite se o cara digitou n√∫meros nos dois campos
      if (inputCasa !== "" && inputFora !== "") {
        palpitesParaSalvar.push({
          id_jogo: jogo.id_jogo,
          id_usuario: idUsuario,
          gols_casa: parseInt(inputCasa),
          gols_fora: parseInt(inputFora)
        });
      }
    });

    if (palpitesParaSalvar.length === 0) {
      alert("Preencha pelo menos um placar para salvar!");
      return;
    }

    // Aqui √© onde enviaremos pro servidor (faremos isso no pr√≥ximo passo)
    // üöÄ ENVIANDO O PACOTE PARA O SERVIDOR!
        try {
          const resposta = await fetch('http://localhost:3000/palpites', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ palpites: palpitesParaSalvar }) // Envia a caixa de palpites
          });

          const resultado = await resposta.json();

          if (resposta.ok) {
            alert("‚úÖ " + resultado.mensagem);
          } else {
            alert("‚ùå Ops: " + resultado.erro);
          }
        } catch (erro) {
          console.error("Erro na conex√£o:", erro);
          alert("Servidor desligado! Verifique o terminal.");
        }
      }


  // 3. FUN√á√ÉO DO BOT√ÉO LIMPAR
  function limparPalpites() {
    const inputs = document.querySelectorAll('.input-placar');
    inputs.forEach(input => input.value = '');
  }

  // Aciona a busca de jogos assim que a p√°gina carrega
  carregarJogos();
// 4. FUN√á√ÉO QUE PREENCHE OS INPUTS E GERA O RESUMO
  async function puxarPalpitesSalvos() {
    const idUsuario = localStorage.getItem('craqueId');
    if (!idUsuario) return;

    try {
      const resposta = await fetch(`http://localhost:3000/meus-palpites/${idUsuario}`);
      const meusPalpites = await resposta.json();

      // Pega a caixa do segundo cart√£o
      const containerResumo = document.getElementById('resumo-palpites');
      containerResumo.innerHTML = ''; // Limpa o texto de "buscando"

      if (meusPalpites.length === 0) {
        containerResumo.innerHTML = '<p class="text-center text-gray-400 font-russo mt-10">Voc√™ ainda n√£o deu nenhum palpite.</p>';
        return;
      }

      // Passa por cada palpite que veio do banco
      meusPalpites.forEach(palpite => {
        
        // 1. PREENCHE AS CAIXINHAS L√Å EM CIMA (Para ele poder editar se quiser)
        const inputCasa = document.getElementById(`casa_${palpite.jogo_id}`);
        const inputFora = document.getElementById(`fora_${palpite.jogo_id}`);
        if (inputCasa && inputFora) {
          inputCasa.value = palpite.gols_casa_palpite;
          inputFora.value = palpite.gols_fora_palpite;
        }

        // 2. ACHA DE QUAL JOGO √â ESSE PALPITE PARA PEGAR OS NOMES E O STATUS
        const jogo = jogosCarregados.find(j => j.id_jogo === palpite.jogo_id);

        if (jogo) {
          // Define a cor da bolinha de status em c√≥digo Hexadecimal
          let corStatus = "color: #4ade80;"; // Verde para aberto
          if (jogo.status.toLowerCase() === "em andamento") corStatus = "color: #facc15;"; // Amarelo
          if (jogo.status.toLowerCase() === "finalizado") corStatus = "color: #f87171;"; // Vermelho

          // 3. DESENHA O COMPROVANTE FIXO RESPEITANDO O SEU CSS
          containerResumo.innerHTML += `
            <div class="linha-jogo" style="margin-bottom: 5px;">
              <span class="nome-time time-casa">${jogo.time_casa}</span>
              
              <div style="display: flex; flex-direction: column; align-items: center;">
                <span class="font-russo" style="${corStatus} font-size: 10px; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 1px;">
                  ‚óè ${jogo.status}
                </span>
                
                <div class="area-placar" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                  <div class="input-placar font-russo" style="display: flex; align-items: center; justify-content: center; background-color: #1f2937; color: white; border: 1px solid #374151;">
                    ${palpite.gols_casa_palpite}
                  </div>
                  
                  <span class="versus">x</span>
                  
                  <div class="input-placar font-russo" style="display: flex; align-items: center; justify-content: center; background-color: #1f2937; color: white; border: 1px solid #374151;">
                    ${palpite.gols_fora_palpite}
                  </div>
                </div>
              </div>
              
              <span class="nome-time time-fora text-left">${jogo.time_fora}</span>
            </div>
            
            <div style="border-bottom: 1px dashed #333; margin: 15px 10% 25px 10%;"></div>
          `;
        }
      });
      
    } catch (erro) {
      console.error("Erro ao puxar os palpites:", erro);
    }
  }
</script>
</body>
</html>