<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Palpitoo - Palpites</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Salsa&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/style.css">

  <style>
    /* â”€â”€ LINHA DE JOGO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .linha-jogo {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 12px;
      padding: 14px 10px;
      border-radius: 12px;
      border: 1px solid var(--borda-divisoria);
      background: var(--bg-dark);
      margin-bottom: 10px;
      transition: border-color 0.2s ease;
    }
    .linha-jogo:hover { border-color: var(--accent-cyan); }
    .linha-jogo.finalizado {
      opacity: 0.6;
      border-color: #f87171;
    }

    /* â”€â”€ NOMES DOS TIMES â”€â”€ */
    .nome-time {
      font-family: 'Russo One', sans-serif;
      font-size: 13px;
      color: var(--text-white);
      line-height: 1.3;
      word-break: break-word;
    }
    .time-casa { text-align: right; }
    .time-fora { text-align: left; }

    /* â”€â”€ ÃREA DO PLACAR â”€â”€ */
    .area-placar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex-shrink: 0;
    }

    /* â”€â”€ INPUT PLACAR â”€â”€ */
    .input-placar {
      width: 48px;
      height: 48px;
      text-align: center;
      font-family: 'Russo One', sans-serif;
      font-size: 18px;
      color: var(--text-white);
      background: var(--bg-escuro, #111827);
      border: 2px solid var(--borda-divisoria);
      border-radius: 10px;
      outline: none;
      box-sizing: border-box;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      /* Remove setas do input number */
      -moz-appearance: textfield;
    }
    .input-placar::-webkit-outer-spin-button,
    .input-placar::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .input-placar:focus {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 3px rgba(var(--accent-cyan-rgb, 122,30,58), 0.15);
    }
    .input-placar:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      border-color: #f87171;
    }

    /* â”€â”€ DISPLAY PLACAR (comprovante) â”€â”€ */
    .placar-display {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Russo One', sans-serif;
      font-size: 18px;
      color: var(--text-white);
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 10px;
      box-sizing: border-box;
    }

    .versus {
      font-family: 'Russo One', sans-serif;
      font-size: 16px;
      color: var(--text-gray);
      flex-shrink: 0;
    }

    /* â”€â”€ AVISO JOGO ENCERRADO â”€â”€ */
    .aviso-encerrado {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-family: 'Russo One', sans-serif;
      font-size: 10px;
      color: #f87171;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    /* â”€â”€ TÃTULO DE RODADA â”€â”€ */
    .titulo-rodada {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 20px 0 12px;
    }
    .titulo-rodada::before,
    .titulo-rodada::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--borda-divisoria);
    }
    .titulo-rodada span {
      font-family: 'Russo One', sans-serif;
      font-size: 13px;
      color: var(--accent-cyan);
      text-transform: uppercase;
      letter-spacing: 2px;
      white-space: nowrap;
    }

    /* â”€â”€ STATUS BADGE â”€â”€ */
    .status-badge {
      font-family: 'Russo One', sans-serif;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 3px 8px;
      border-radius: 6px;
      white-space: nowrap;
    }
    .status-badge.aberto     { background: rgba(74,222,128,0.12); color: #4ade80; border: 1px solid rgba(74,222,128,0.3); }
    .status-badge.andamento  { background: rgba(250,204,21,0.12); color: #facc15; border: 1px solid rgba(250,204,21,0.3); }
    .status-badge.finalizado { background: rgba(248,113,113,0.12); color: #f87171; border: 1px solid rgba(248,113,113,0.3); }

    /* â”€â”€ ÃREA CENTRAL DO COMPROVANTE â”€â”€ */
    .centro-comprovante {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    /* â”€â”€ PONTOS OBTIDOS â”€â”€ */
    .pontos-obtidos {
      font-family: 'Russo One', sans-serif;
      font-size: 12px;
      padding: 3px 10px;
      border-radius: 8px;
    }
    .pontos-obtidos.exato    { background: rgba(34,197,94,0.15);  color: #22c55e; }
    .pontos-obtidos.vencedor { background: rgba(234,179,8,0.15);  color: #eab308; }
    .pontos-obtidos.errou    { background: rgba(248,113,113,0.15);color: #f87171; }

    /* â”€â”€ DIVISOR â”€â”€ */
    .divisor-jogo {
      border: none;
      border-top: 1px dashed var(--borda-divisoria);
      margin: 6px 8% 16px;
    }

    /* â”€â”€ BOTÃ•ES â”€â”€ */
    .botoes-acao {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .botoes-acao .btn { flex: 1; min-width: 120px; max-width: 200px; }

    /* â”€â”€ MOBILE â”€â”€ */
    @media (max-width: 480px) {
      .linha-jogo {
        grid-template-columns: 1fr auto 1fr;
        gap: 8px;
        padding: 12px 8px;
      }
      .nome-time { font-size: 11px; }
      .input-placar, .placar-display { width: 42px; height: 42px; font-size: 16px; }
      .botoes-acao .btn { max-width: 100%; }
    }
  </style>
</head>
<body>

  <header class="navbar">
    <a href="_index.html" class="logo-link">
      <img src="./img/pato.png" alt="Logo Palpitoo" class="logo-imagem">
    </a>
    <nav>
      <ul class="nav-links">
        <li><a href="_index.html">InÃ­cio</a></li>
        <li><a href="minhaliga.html">Ligas</a></li>
        <li><a href="palpites.html" class="ativo">Palpites</a></li>
        <li><a href="novidades.html">Novidades</a></li>
        <li><a href="social.html">Social</a></li>
        <li><a href="carreira.html">Carreira</a></li>
      </ul>
    </nav>
  </header>

  <main class="container-principal container-palpites">

    <!-- CARD: FAZER PALPITES -->
    <section class="cartao bg-escuro cartao-palpite animacao-suave">
      <div class="cabecalho-palpite mb-20">
        <h2 class="font-russo titulo-branco text-center">Palpites da Rodada</h2>
        <p class="subtitulo-tempo text-center">Deixe seus palpites para os prÃ³ximos jogos</p>
      </div>

      <div class="lista-jogos" id="container-jogos">
        <p class="text-center font-russo mt-10" style="color: var(--text-gray);">Buscando tabela de jogos... ğŸ”„</p>
      </div>

      <div class="botoes-acao mt-20">
        <button class="btn btn-cancelar font-russo" onclick="limparPalpites()">Limpar</button>
        <button class="btn btn-salvar font-russo"   onclick="enviarTodosPalpites()">Salvar Palpites</button>
      </div>
    </section>

    <!-- CARD: COMPROVANTES -->
    <section class="cartao bg-escuro cartao-palpite animacao-suave mt-20">
      <div class="cabecalho-palpite mb-20">
        <h2 class="font-russo titulo-branco text-center">Meus Palpites Registrados</h2>
        <p class="subtitulo-tempo text-center">Acompanhe o andamento das partidas</p>
      </div>
      <div class="lista-jogos" id="resumo-palpites">
        <p class="text-center font-russo mt-10" style="color: var(--text-gray);">Buscando seus comprovantes... ğŸ”„</p>
      </div>
    </section>

  </main>

  <!-- TOASTS -->
  <div id="container-avisos"></div>

<script>
  let jogosCarregados = [];

  // â”€â”€ TOAST (substitui alert()) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function mostrarAviso(msg, tipo = 'info') {
    const cont  = document.getElementById('container-avisos');
    const toast = document.createElement('div');
    const icone = tipo === 'sucesso' ? 'âœ…' : tipo === 'erro' ? 'âŒ' : 'â„¹ï¸';
    toast.className = `aviso-toast aviso-${tipo}`;
    toast.innerHTML = `<span>${icone}</span><span>${msg}</span>`;
    cont.appendChild(toast);
    setTimeout(() => {
      toast.classList.add('aviso-saindo');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // â”€â”€ STATUS BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function statusBadge(status) {
    const s = status.toLowerCase();
    if (s === 'finalizado')  return `<span class="status-badge finalizado">ğŸ”’ Finalizado</span>`;
    if (s === 'em andamento') return `<span class="status-badge andamento">ğŸŸ¡ Em andamento</span>`;
    return `<span class="status-badge aberto">ğŸŸ¢ Aberto</span>`;
  }

  // 1. CARREGAR E DESENHAR OS JOGOS POR RODADA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function carregarJogos() {
    try {
      const resposta    = await fetch('http://localhost:3000/jogos');
      jogosCarregados   = await resposta.json();
      const container   = document.getElementById('container-jogos');
      container.innerHTML = '';

      if (!jogosCarregados.length) {
        container.innerHTML = '<p class="text-center font-russo mt-10" style="color:var(--text-gray);">Nenhum jogo liberado ainda.</p>';
        return;
      }

      // Agrupa por rodada
      const porRodada = {};
      jogosCarregados.forEach(j => {
        const r = j.rodada || 1;
        if (!porRodada[r]) porRodada[r] = [];
        porRodada[r].push(j);
      });

      for (const rodada in porRodada) {
        // TÃ­tulo da rodada
        container.innerHTML += `
          <div class="titulo-rodada">
            <span>ğŸ† Rodada ${rodada}</span>
          </div>`;

        porRodada[rodada].forEach(jogo => {
          const finalizado = jogo.status.toLowerCase() === 'finalizado';

          container.innerHTML += `
            <div class="linha-jogo ${finalizado ? 'finalizado' : ''}">
              <span class="nome-time time-casa">${jogo.time_casa}</span>

              <div class="area-placar">
                <input type="number" id="casa_${jogo.id_jogo}"
                       class="input-placar font-russo"
                       placeholder="0" min="0"
                       ${finalizado ? 'disabled' : ''}>
                <span class="versus">x</span>
                <input type="number" id="fora_${jogo.id_jogo}"
                       class="input-placar font-russo"
                       placeholder="0" min="0"
                       ${finalizado ? 'disabled' : ''}>
              </div>

              <span class="nome-time time-fora">${jogo.time_fora}</span>
            </div>
            ${finalizado ? '<p class="aviso-encerrado">ğŸ”’ Palpites encerrados para este jogo</p>' : ''}`;
        });
      }

      puxarPalpitesSalvos();
    } catch (err) {
      console.error('Erro:', err);
      document.getElementById('container-jogos').innerHTML =
        '<p class="text-center font-russo mt-10" style="color:#f87171;">Erro ao conectar com o servidor.</p>';
    }
  }

  // 2. ENVIAR PALPITES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function enviarTodosPalpites() {
    const idUsuario = localStorage.getItem('craqueId') || localStorage.getItem('id_craque');
    if (!idUsuario) { mostrarAviso('VocÃª precisa estar logado para salvar seus palpites!', 'erro'); return; }

    const palpitesParaSalvar = [];
    jogosCarregados.forEach(jogo => {
      const inputCasa = document.getElementById(`casa_${jogo.id_jogo}`);
      const inputFora = document.getElementById(`fora_${jogo.id_jogo}`);
      if (inputCasa && inputFora && inputCasa.value !== '' && inputFora.value !== '') {
        palpitesParaSalvar.push({
          id_jogo:   jogo.id_jogo,
          id_usuario: idUsuario,
          gols_casa: parseInt(inputCasa.value),
          gols_fora: parseInt(inputFora.value)
        });
      }
    });

    if (!palpitesParaSalvar.length) {
      mostrarAviso('Preencha pelo menos um placar para salvar!', 'erro');
      return;
    }

    try {
      const resposta = await fetch('http://localhost:3000/palpites', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ palpites: palpitesParaSalvar })
      });
      const resultado = await resposta.json();

      if (resposta.ok) {
        mostrarAviso(resultado.mensagem, 'sucesso');
        puxarPalpitesSalvos();
      } else {
        mostrarAviso(resultado.erro || 'Erro ao salvar.', 'erro');
      }
    } catch (err) {
      console.error(err);
      mostrarAviso('Servidor desligado! Verifique o terminal.', 'erro');
    }
  }

  // 3. LIMPAR INPUTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function limparPalpites() {
    document.querySelectorAll('.input-placar:not(:disabled)').forEach(i => i.value = '');
    mostrarAviso('Palpites limpos.', 'info');
  }

  // 4. PUXAR PALPITES SALVOS E GERAR COMPROVANTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function puxarPalpitesSalvos() {
    const idUsuario = localStorage.getItem('craqueId') || localStorage.getItem('id_craque');
    if (!idUsuario) return;

    try {
      const resposta    = await fetch(`http://localhost:3000/meus-palpites/${idUsuario}`);
      const meusPalpites = await resposta.json();
      const containerResumo = document.getElementById('resumo-palpites');
      containerResumo.innerHTML = '';

      if (!meusPalpites.length) {
        containerResumo.innerHTML =
          '<p class="text-center font-russo mt-10" style="color:var(--text-gray);">VocÃª ainda nÃ£o deu nenhum palpite.</p>';
        return;
      }

      // Preenche inputs para ediÃ§Ã£o
      meusPalpites.forEach(p => {
        const iCasa = document.getElementById(`casa_${p.jogo_id}`);
        const iFora = document.getElementById(`fora_${p.jogo_id}`);
        if (iCasa && iFora) { iCasa.value = p.gols_casa_palpite; iFora.value = p.gols_fora_palpite; }
      });

      // Agrupa comprovantes por rodada
      const porRodada = {};
      meusPalpites.forEach(p => {
        const jogo = jogosCarregados.find(j => j.id_jogo === p.jogo_id);
        if (!jogo) return;
        const r = jogo.rodada || 1;
        if (!porRodada[r]) porRodada[r] = [];
        porRodada[r].push({ palpite: p, jogo });
      });

      for (const rodada in porRodada) {
        containerResumo.innerHTML += `
          <div class="titulo-rodada">
            <span>Rodada ${rodada}</span>
          </div>`;

        porRodada[rodada].forEach(({ palpite, jogo }) => {
          const s = jogo.status.toLowerCase();

          // Badge de pontos (sÃ³ mostra se finalizado e tiver pontos)
          let ptsBadge = '';
          if (s === 'finalizado' && palpite.pontos_obtidos !== null && palpite.pontos_obtidos !== undefined) {
            if (palpite.pontos_obtidos === 3)      ptsBadge = '<span class="pontos-obtidos exato">ğŸ¯ +3pts â€” Exato!</span>';
            else if (palpite.pontos_obtidos === 1)  ptsBadge = '<span class="pontos-obtidos vencedor">âœ… +1pt â€” Vencedor</span>';
            else                                    ptsBadge = '<span class="pontos-obtidos errou">âŒ 0pts â€” Errou</span>';
          }

          containerResumo.innerHTML += `
            <div class="linha-jogo" style="margin-bottom:6px;">
              <span class="nome-time time-casa">${jogo.time_casa}</span>

              <div class="centro-comprovante">
                ${statusBadge(jogo.status)}
                <div class="area-placar">
                  <div class="placar-display">${palpite.gols_casa_palpite}</div>
                  <span class="versus">x</span>
                  <div class="placar-display">${palpite.gols_fora_palpite}</div>
                </div>
                ${ptsBadge}
              </div>

              <span class="nome-time time-fora">${jogo.time_fora}</span>
            </div>
            <hr class="divisor-jogo">`;
        });
      }

    } catch (err) {
      console.error('Erro ao puxar palpites:', err);
    }
  }

  carregarJogos();
</script>
<script src="main.js"></script>
</body>
</html>