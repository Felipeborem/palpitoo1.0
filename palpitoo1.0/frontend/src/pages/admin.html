<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Palpitoo - Painel do ADM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
  <style>
    .font-russo { font-family: 'Russo One', sans-serif; }
    .tabela-scroll { max-height: 400px; overflow-y: auto; }
    .tabela-scroll::-webkit-scrollbar { width: 8px; }
    .tabela-scroll::-webkit-scrollbar-track { background: #1f2937; }
    .tabela-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center py-10 px-4">

  <h1 class="text-4xl font-russo text-red-500 mb-2">Painel Secreto do ADM üïµÔ∏è‚Äç‚ôÇÔ∏è</h1>
  <p class="text-gray-400 mb-10">Controle de Jogos e Fiscaliza√ß√£o de Ligas.</p>

  <div class="flex flex-col md:flex-row gap-8 w-full max-w-6xl mb-12">
    
    <div class="flex flex-col w-full md:w-1/3 gap-6">
      
      <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border-t-4 border-green-500 h-fit">
        <h2 class="text-xl font-russo text-white text-center mb-4">Criar Novo Jogo</h2>
        <div class="flex flex-col gap-3">
          <div>
            <label class="text-xs text-green-400 font-bold">Rodada:</label>
            <input type="number" id="inputRodada" placeholder="Ex: 1" class="w-full mt-1 p-2 rounded bg-gray-700 text-white font-bold text-center outline-none focus:ring-2 focus:ring-green-500 border border-green-800">
          </div>
          
          <div>
            <label class="text-xs text-gray-400 font-bold">Time da Casa:</label>
            <input type="text" id="inputTimeCasa" placeholder="Ex: FLAMENGO" class="w-full mt-1 p-2 rounded bg-gray-700 text-white font-bold text-center uppercase outline-none focus:ring-2 focus:ring-green-500">
          </div>
          <div class="text-center font-russo text-gray-500">X</div>
          <div>
            <label class="text-xs text-gray-400 font-bold">Time de Fora:</label>
            <input type="text" id="inputTimeFora" placeholder="Ex: VASCO" class="w-full mt-1 p-2 rounded bg-gray-700 text-white font-bold text-center uppercase outline-none focus:ring-2 focus:ring-green-500">
          </div>
          <button onclick="criarNovoJogo()" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-russo py-3 px-4 rounded transition w-full">
            ‚ûï CADASTRAR JOGO
          </button>
        </div>
      </div>

      <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border-t-4 border-red-500 h-fit">
        <h2 class="text-xl font-russo text-white text-center mb-4">Encerrar Partida</h2>
        <div class="flex flex-col gap-3">
          <div>
            <label class="text-xs text-gray-400 font-bold">ID do Jogo:</label>
            <input type="number" id="inputIdJogo" placeholder="Ex: 1" class="w-full mt-1 p-2 rounded bg-gray-700 text-white font-bold text-center outline-none focus:ring-2 focus:ring-red-500">
          </div>
          <div class="flex justify-center items-center gap-4 mt-2">
            <div class="flex flex-col items-center">
              <label class="text-[10px] text-gray-400 mb-1">Casa</label>
              <input type="number" id="inputGolsCasa" class="w-14 h-12 text-center text-xl font-bold rounded bg-gray-700 text-white">
            </div>
            <span class="font-russo text-lg text-gray-500 mt-4">X</span>
            <div class="flex flex-col items-center">
              <label class="text-[10px] text-gray-400 mb-1">Fora</label>
              <input type="number" id="inputGolsFora" class="w-14 h-12 text-center text-xl font-bold rounded bg-gray-700 text-white">
            </div>
          </div>
          <button onclick="dispararEncerramento()" class="mt-4 bg-red-600 hover:bg-red-700 text-white font-russo py-3 px-4 rounded transition w-full">
            üö® ENCERRAR JOGO üö®
          </button>
        </div>
      </div>

      <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border-t-4 border-yellow-500 h-fit">
        <h2 class="text-xl font-russo text-white text-center mb-1">‚è∞ Prazo de Palpites</h2>
        <p class="text-xs text-gray-400 text-center mb-4">Define quando o mercado fecha para uma rodada inteira.</p>
        <div class="flex flex-col gap-3">
          <div>
            <label class="text-xs text-yellow-400 font-bold">Rodada:</label>
            <input type="number" id="inputPrazoRodada" placeholder="Ex: 3"
              class="w-full mt-1 p-2 rounded bg-gray-700 text-white font-bold text-center outline-none focus:ring-2 focus:ring-yellow-500 border border-yellow-800">
          </div>
          <div>
            <label class="text-xs text-yellow-400 font-bold">Prazo limite para palpitar:</label>
            <input type="datetime-local" id="inputPrazoDataHora"
              class="w-full mt-1 p-2 rounded bg-gray-700 text-white font-bold text-center outline-none focus:ring-2 focus:ring-yellow-500 border border-yellow-800">
            <p class="text-xs text-gray-500 mt-1">Quando bater esse hor√°rio ‚Üí üî¥ AO VIVO, ningu√©m mais palpita.</p>
          </div>
          <div id="prazos-atuais" class="text-xs text-gray-500 mt-1"></div>
          <button onclick="definirPrazoRodada()" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white font-russo py-3 px-4 rounded transition w-full">
            ‚è∞ DEFINIR PRAZO
          </button>
        </div>
      </div>

    </div>

    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border-t-4 border-blue-500 w-full md:w-2/3">
      <h2 class="text-xl font-russo text-white text-center mb-2">Lista de Jogos</h2>
      <p class="text-xs text-gray-400 text-center mb-4">Clique em um jogo para selecionar o ID para encerramento.</p>
      
      <div class="tabela-scroll">
        <table class="w-full text-sm text-left text-gray-300">
          <thead class="text-xs text-gray-400 uppercase bg-gray-700 font-russo sticky top-0">
            <tr>
              <th class="px-4 py-3 text-center">ID</th>
              <th class="px-4 py-3 text-center text-green-400">Rod.</th>
              <th class="px-4 py-3 text-right">Casa</th>
              <th class="px-4 py-3 text-center">X</th>
              <th class="px-4 py-3 text-left">Fora</th>
              <th class="px-4 py-3 text-center">Status</th>
            </tr>
          </thead>
          <tbody id="tabelaJogosBody">
            <tr><td colspan="6" class="text-center py-6">Carregando jogos...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <hr class="w-full max-w-6xl border-gray-700 mb-12">

  <div class="flex flex-col md:flex-row gap-8 w-full max-w-6xl">
    
    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border-t-4 border-yellow-500 w-full md:w-1/2">
      <h2 class="text-xl font-russo text-white text-center mb-2">Ligas Criadas</h2>
      <p class="text-xs text-gray-400 text-center mb-4">Clique em uma liga para ver quem est√° nela.</p>

      <div class="tabela-scroll">
        <table class="w-full text-sm text-left text-gray-300">
          <thead class="text-xs text-gray-400 uppercase bg-gray-700 font-russo sticky top-0">
            <tr>
              <th class="px-4 py-3">Liga</th>
              <th class="px-4 py-3 text-center">C√≥digo</th>
              <th class="px-4 py-3 text-center">Dono</th>
              <th class="px-4 py-3 text-center">Membros</th>
            </tr>
          </thead>
          <tbody id="tabelaLigasBody">
            <tr><td colspan="4" class="text-center py-6">Carregando ligas...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border-t-4 border-purple-500 w-full md:w-1/2">
      <h2 class="text-xl font-russo text-white text-center mb-2" id="tituloMembros">Membros da Liga</h2>
      <p class="text-xs text-gray-400 text-center mb-4">Selecione uma liga ao lado.</p>

      <div class="tabela-scroll">
        <table class="w-full text-sm text-left text-gray-300">
          <thead class="text-xs text-gray-400 uppercase bg-gray-700 font-russo sticky top-0">
            <tr>
              <th class="px-4 py-3 text-center">ID</th>
              <th class="px-4 py-3">Nome do Craque</th>
              <th class="px-4 py-3">Time</th>
            </tr>
          </thead>
          <tbody id="tabelaMembrosBody">
            <tr><td colspan="3" class="text-center py-6 text-gray-500">Nenhuma liga selecionada.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    // ================= HELPERS =================
    function formatarDataHora(iso) {
      if (!iso) return '‚Äî';
      const d = new Date(iso);
      return d.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' });
    }

    // ================= FUN√á√ïES DE JOGOS =================
    async function carregarListaDeJogos() {
      try {
        const resposta = await fetch('https://palpitoo-api.onrender.com/jogos');
        const jogos = await resposta.json();
        const tbody = document.getElementById('tabelaJogosBody');
        tbody.innerHTML = ''; 

        jogos.forEach(jogo => {
          let corStatus = jogo.status.toLowerCase() === "finalizado" ? "text-red-400" : "text-blue-400";
          
          // Adicionamos a coluna da rodada (jogo.rodada)
          tbody.innerHTML += `
            <tr class="border-b border-gray-700 hover:bg-gray-600 cursor-pointer transition" onclick="selecionarJogo(${jogo.id_jogo})">
              <td class="px-4 py-3 text-center font-bold text-white">${jogo.id_jogo}</td>
              <td class="px-4 py-3 text-center font-bold text-green-400 bg-gray-800">${jogo.rodada || 1}</td>
              <td class="px-4 py-3 text-right font-russo">${jogo.time_casa}</td>
              <td class="px-4 py-3 text-center font-bold">${jogo.status === 'finalizado' ? `<span class="text-gray-400">${jogo.gols_casa_real} x ${jogo.gols_fora_real}</span>` : 'x'}</td>
              <td class="px-4 py-3 text-left font-russo">${jogo.time_fora}</td>
              <td class="px-4 py-3 text-center font-bold ${corStatus} uppercase text-xs">${jogo.status}</td>
            </tr>
          `;
        });
      } catch (erro) { console.error(erro); }
    }

    // FUN√á√ÉO ATUALIZADA: CRIAR JOGO COM RODADA
    async function criarNovoJogo() {
      const rodada   = document.getElementById('inputRodada').value;
      const timeCasa = document.getElementById('inputTimeCasa').value.trim().toUpperCase();
      const timeFora = document.getElementById('inputTimeFora').value.trim().toUpperCase();

      if (!rodada || !timeCasa || !timeFora) {
        return alert("Preencha a rodada e o nome dos dois times!");
      }

      try {
        const resposta = await fetch('https://palpitoo-api.onrender.com/criar-jogo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            rodada:    parseInt(rodada),
            time_casa: timeCasa, 
            time_fora: timeFora
          })
        });

        const resultado = await resposta.json();

        if (resposta.ok) {
          alert("‚úÖ " + resultado.mensagem);
          document.getElementById('inputTimeCasa').value = '';
          document.getElementById('inputTimeFora').value = '';
          carregarListaDeJogos();
        } else {
          alert("‚ùå Erro: " + resultado.erro);
        }
      } catch (erro) {
        console.error(erro);
        alert("Erro ao conectar com o servidor para criar jogo.");
      }
    }

    // ‚îÄ‚îÄ DEFINIR PRAZO POR RODADA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function definirPrazoRodada() {
      const rodada  = document.getElementById('inputPrazoRodada').value;
      const prazo   = document.getElementById('inputPrazoDataHora').value;

      if (!rodada) return alert("Informe o n√∫mero da rodada!");
      if (!prazo)  return alert("Defina o hor√°rio limite!");

      try {
        const resposta = await fetch('https://palpitoo-api.onrender.com/definir-prazo-rodada', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rodada: parseInt(rodada), prazo_rodada: prazo })
        });

        const resultado = await resposta.json();

        if (resposta.ok) {
          // Salva tamb√©m no localStorage como fallback visual
          const prazos = JSON.parse(localStorage.getItem('prazos_rodadas') || '{}');
          prazos[rodada] = prazo;
          localStorage.setItem('prazos_rodadas', JSON.stringify(prazos));

          alert(`‚úÖ Prazo definido! Rodada ${rodada} fecha em ${formatarDataHora(prazo)}`);
          document.getElementById('inputPrazoRodada').value   = '';
          document.getElementById('inputPrazoDataHora').value = '';
          renderPrazosAtuais();
          carregarListaDeJogos();
        } else {
          // Se o endpoint n√£o existir ainda, salva s√≥ no localStorage como fallback
          const prazos = JSON.parse(localStorage.getItem('prazos_rodadas') || '{}');
          prazos[rodada] = prazo;
          localStorage.setItem('prazos_rodadas', JSON.stringify(prazos));
          alert(`‚ö†Ô∏è Prazo salvo localmente (backend n√£o respondeu). Rodada ${rodada} ‚Üí ${formatarDataHora(prazo)}`);
          document.getElementById('inputPrazoRodada').value   = '';
          document.getElementById('inputPrazoDataHora').value = '';
          renderPrazosAtuais();
        }
      } catch (erro) {
        // Mesmo sem servidor, salva no localStorage
        const rodadaN = document.getElementById('inputPrazoRodada').value;
        const prazoV  = document.getElementById('inputPrazoDataHora').value;
        const prazos  = JSON.parse(localStorage.getItem('prazos_rodadas') || '{}');
        prazos[rodadaN] = prazoV;
        localStorage.setItem('prazos_rodadas', JSON.stringify(prazos));
        alert(`‚ö†Ô∏è Servidor offline. Prazo salvo localmente: Rodada ${rodadaN} ‚Üí ${formatarDataHora(prazoV)}`);
        document.getElementById('inputPrazoRodada').value   = '';
        document.getElementById('inputPrazoDataHora').value = '';
        renderPrazosAtuais();
      }
    }

    function renderPrazosAtuais() {
      const prazos = JSON.parse(localStorage.getItem('prazos_rodadas') || '{}');
      const div = document.getElementById('prazos-atuais');
      const keys = Object.keys(prazos).sort((a,b) => Number(a)-Number(b));
      if (!keys.length) { div.innerHTML = ''; return; }
      div.innerHTML = '<p class="text-yellow-300 font-bold mb-1">Prazos definidos:</p>' +
        keys.map(r => `<p>Rodada ${r}: <span class="text-white">${formatarDataHora(prazos[r])}</span></p>`).join('');
    }

    function selecionarJogo(id) {
      document.getElementById('inputIdJogo').value = id;
    }

    async function dispararEncerramento() {
      const idJogo = document.getElementById('inputIdJogo').value;
      const golsCasa = document.getElementById('inputGolsCasa').value;
      const golsFora = document.getElementById('inputGolsFora').value;

      if (!idJogo || golsCasa === "" || golsFora === "") return alert("Preencha o placar real!");
      if (!confirm(`Confirmar fim de jogo: ID ${idJogo}?`)) return;

      try {
        const resposta = await fetch('https://palpitoo-api.onrender.com/encerrar-jogo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id_jogo: parseInt(idJogo), gols_casa_real: parseInt(golsCasa), gols_fora_real: parseInt(golsFora) })
        });
        if (resposta.ok) {
          alert("‚úÖ Jogo encerrado!");
          document.getElementById('inputGolsCasa').value = '';
          document.getElementById('inputGolsFora').value = '';
          carregarListaDeJogos();
        }
      } catch (erro) { console.error(erro); }
    }

    // ================= FUN√á√ïES DE LIGAS =================
    async function carregarTodasLigas() {
      try {
        const resposta = await fetch('https://palpitoo-api.onrender.com/todas-ligas');
        const ligas = await resposta.json();
        const tbody = document.getElementById('tabelaLigasBody');
        tbody.innerHTML = ''; 

        if (ligas.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center py-6 text-gray-500">Nenhuma liga criada no sistema ainda.</td></tr>';
          return;
        }

        ligas.forEach(liga => {
          tbody.innerHTML += `
            <tr class="border-b border-gray-700 hover:bg-gray-600 cursor-pointer transition" onclick="carregarMembrosLiga(${liga.id_liga}, '${liga.nome}')">
              <td class="px-4 py-3 font-russo text-white">${liga.nome}</td>
              <td class="px-4 py-3 text-center font-mono text-yellow-400 font-bold tracking-widest">${liga.codigo_convite}</td>
              <td class="px-4 py-3 text-center text-gray-400 text-xs uppercase">${liga.nome_dono || 'Desconhecido'}</td>
              <td class="px-4 py-3 text-center font-bold text-cyan-400">${liga.total_membros} üë§</td>
            </tr>
          `;
        });
      } catch (erro) { console.error(erro); }
    }

    async function carregarMembrosLiga(idLiga, nomeLiga) {
      document.getElementById('tituloMembros').innerText = `Membros: ${nomeLiga}`;
      const tbody = document.getElementById('tabelaMembrosBody');
      tbody.innerHTML = '<tr><td colspan="3" class="text-center py-6 text-yellow-500">Buscando craques...</td></tr>';

      try {
        const resposta = await fetch(`https://palpitoo-api.onrender.com/liga-membros/${idLiga}`);
        const membros = await resposta.json();
        tbody.innerHTML = ''; 

        if (membros.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="text-center py-6 text-gray-500">Liga vazia.</td></tr>';
          return;
        }

        membros.forEach(membro => {
          tbody.innerHTML += `
            <tr class="border-b border-gray-700 hover:bg-gray-750">
              <td class="px-4 py-3 text-center text-gray-500 text-xs">${membro.id}</td>
              <td class="px-4 py-3 font-bold text-white">${membro.nome}</td>
              <td class="px-4 py-3 text-gray-400 uppercase text-xs">${membro.time_favorito || 'Sem Time'}</td>
            </tr>
          `;
        });
      } catch (erro) { console.error(erro); }
    }

    carregarListaDeJogos();
    carregarTodasLigas();
    renderPrazosAtuais();
  </script>
</body>
</html>